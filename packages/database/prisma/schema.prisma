generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  TEACHER
  PARENT
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  role      Role     @default(PARENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  teacherProfile TeacherProfile?
  parentProfile  ParentProfile?
}

model TeacherProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  classes Class[] // Classes taught by this teacher
}

model ParentProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  students Student[] // Children of this parent
}

model Student {
  id        String   @id @default(uuid())
  name      String
  dob       DateTime
  gender    String
  icNo      String   @unique
  race      String
  address   String?

  // No enrollment details here anymore

  // Personal Info
  religion    String?
  nationality String?

  // Parent Info
  fatherName       String?
  fatherIc         String?
  fatherOccupation String?
  motherName       String?
  motherIc         String?
  motherOccupation String?

  // Emergency Info
  emergencyName    String?
  emergencyPhone   String?
  emergencyAddress String?

  enrollments Enrollment[]
  
  // existing relations
  parentId String?
  parent   ParentProfile? @relation(fields: [parentId], references: [id])

  attendances Attendance[]
  fees        Fee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
}

model Enrollment {
  id        String   @id @default(uuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id])

  academicYear    Int
  enrollmentLevel EnrollmentLevel
  programType     ProgramType
  transport       Boolean @default(false)
  remarks         String?
  status          EnrollmentStatus @default(ACTIVE)
  isNewStudent    Boolean @default(true)

  classId String?
  class   Class?  @relation(fields: [classId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, academicYear])
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  WITHDRAWN
}

enum EnrollmentLevel {
  M2
  M3
  M4
  M5
  M6
}

enum ProgramType {
  HALF_DAY_MORNING
  HALF_DAY_AFTERNOON
  MORNING_STAY_BACK
  AFTERNOON_STAY_BACK
  FULL_DAY
}

model Building {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  classes     Class[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Class {
  id          String   @id @default(uuid())
  name        String
  description String?
  capacity    Int
  level       EnrollmentLevel @default(M2)
  isActive    Boolean  @default(true)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  buildingId String
  building   Building @relation(fields: [buildingId], references: [id])

  teacherId   String?
  teacher     TeacherProfile? @relation(fields: [teacherId], references: [id])

  enrollments Enrollment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, academicYearId])
}

model Attendance {
  id        String   @id @default(uuid())
  date      DateTime
  status    String   // PRESENT, ABSENT, LATE, EXCUSED
  studentId String
  student   Student  @relation(fields: [studentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Fee {
  id          String   @id @default(uuid())
  amount      Float
  dueDate     DateTime
  status      String   // PENDING, PAID, OVERDUE
  description String
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AcademicYear {
  id        String             @id @default(uuid())
  year      Int                @unique
  status    AcademicYearStatus @default(INACTIVE)
  startDate   DateTime?
  endDate   DateTime?
  classes   Class[]
  feePackages FeePackage[]
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
}

enum AcademicYearStatus {
  ACTIVE
  COMPLETED
  INACTIVE
}

enum BillingPeriod {
  YEARLY
  FIRST_HALF_YEAR
  SECOND_HALF_YEAR
}

enum ChargeType {
  ONE_TIME
  MONTHLY
}

model FeeItem {
  id            String           @id @default(uuid())
  name          String
  code          String           @unique
  defaultAmount Float
  chargeType    ChargeType       @default(ONE_TIME)
  description   String?
  isActive      Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  feePackageItems FeePackageItem[]
}

model FeePackage {
  id             String          @id @default(uuid())
  name           String
  level          EnrollmentLevel
  academicYearId String
  academicYear   AcademicYear    @relation(fields: [academicYearId], references: [id])
  billingPeriod  BillingPeriod
  description    String?
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  feePackageItems FeePackageItem[]

  @@unique([academicYearId, level, billingPeriod])
}

model FeePackageItem {
  id           String     @id @default(uuid())
  feePackageId String
  feePackage   FeePackage @relation(fields: [feePackageId], references: [id], onDelete: Cascade)
  feeItemId    String
  feeItem      FeeItem    @relation(fields: [feeItemId], references: [id], onDelete: Restrict)
  unitAmount   Float?     
  quantity     Int        @default(1)
  sortOrder    Int        @default(0)

  @@unique([feePackageId, feeItemId])
}
